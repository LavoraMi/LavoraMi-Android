name: Build and Release APK

on:
  # Trigger manuale con possibilitÃ  di specificare il tag
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Nome del tag (es: v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Nome della release'
        required: true
        default: 'Release v1.0.0'
      prerelease:
        description: 'Pre-release?'
        required: false
        type: boolean
        default: false
  
  # Oppure trigger automatico quando si pusha un tag
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug
      
      - name: Build Release APK
        run: ./gradlew assembleRelease
      
      - name: Get version from build.gradle
        id: get_version
        run: |
          VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk '{print $3}' | tr -d '"' || echo "1.0.0")
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Version found: $VERSION_NAME"
      
      - name: Find APK files
        id: find_apk
        run: |
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          DEBUG_APK_NAME=$(basename "$DEBUG_APK")
          RELEASE_APK_NAME=$(basename "$RELEASE_APK")
          
          echo "debug_apk=$DEBUG_APK" >> $GITHUB_OUTPUT
          echo "release_apk=$RELEASE_APK" >> $GITHUB_OUTPUT
          echo "debug_apk_name=$DEBUG_APK_NAME" >> $GITHUB_OUTPUT
          echo "release_apk_name=$RELEASE_APK_NAME" >> $GITHUB_OUTPUT
          
          echo "Debug APK: $DEBUG_APK"
          echo "Release APK: $RELEASE_APK"
      
      - name: Get APK info
        id: apk_info
        run: |
          DEBUG_SIZE=$(du -h "${{ steps.find_apk.outputs.debug_apk }}" | cut -f1)
          RELEASE_SIZE=$(du -h "${{ steps.find_apk.outputs.release_apk }}" | cut -f1)
          echo "debug_size=$DEBUG_SIZE" >> $GITHUB_OUTPUT
          echo "release_size=$RELEASE_SIZE" >> $GITHUB_OUTPUT
      
      - name: Determine tag name
        id: tag_info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
            RELEASE_NAME="${{ github.event.inputs.release_name }}"
            PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            RELEASE_NAME="Release ${TAG_NAME}"
            PRERELEASE="false"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: ${{ steps.tag_info.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.tag_info.outputs.prerelease }}
          body: |
            ## ðŸš€ LavoraMi Android - ${{ steps.tag_info.outputs.release_name }}
            
            ### ðŸ“± Download
            
            Scegli la versione appropriata per il tuo dispositivo:
            
            - **ðŸ› Debug APK** (`${{ steps.find_apk.outputs.debug_apk_name }}`) - ${{ steps.apk_info.outputs.debug_size }}
              - Per test e sviluppo
              - Include log e debugging
            
            - **ðŸš€ Release APK** (`${{ steps.find_apk.outputs.release_apk_name }}`) - ${{ steps.apk_info.outputs.release_size }}
              - Versione ottimizzata
              - Nota: non firmato per produzione
            
            ### ðŸ“‹ Informazioni Build
            
            - **Commit**: `${{ github.sha }}`
            - **Branch**: `${{ github.ref_name }}`
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Versione App**: ${{ steps.get_version.outputs.version_name }}
            
            ### ðŸ“¥ Installazione
            
            1. Scarica l'APK desiderato
            2. Sul tuo dispositivo Android, abilita "Installa da fonti sconosciute"
            3. Apri l'APK e conferma l'installazione
            
            ### ðŸ”— Link Utili
            
            - [ðŸ“– Repository](https://github.com/${{ github.repository }})
            - [ðŸ› Segnala un Bug](https://github.com/${{ github.repository }}/issues)
            - [ðŸ’¡ Richiedi una Feature](https://github.com/${{ github.repository }}/issues)
            
            ---
            
            **Fatto con â¤ï¸ per la mobilitÃ  urbana milanese**
          files: |
            ${{ steps.find_apk.outputs.debug_apk }}
            ${{ steps.find_apk.outputs.release_apk }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Debug APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ steps.tag_info.outputs.tag_name }}
          path: ${{ steps.find_apk.outputs.debug_apk }}
          retention-days: 90
      
      - name: Upload Release APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ steps.tag_info.outputs.tag_name }}
          path: ${{ steps.find_apk.outputs.release_apk }}
          retention-days: 90
      
      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.tag_info.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: ${{ steps.tag_info.outputs.release_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Files" >> $GITHUB_STEP_SUMMARY
          echo "- Debug: ${{ steps.find_apk.outputs.debug_apk_name }} (${{ steps.apk_info.outputs.debug_size }})" >> $GITHUB_STEP_SUMMARY
          echo "- Release: ${{ steps.find_apk.outputs.release_apk_name }} (${{ steps.apk_info.outputs.release_size }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_info.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
